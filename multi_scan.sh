#!/bin/bash
# run this command in the background like this: $ nohup ./do_scan.sh & or as a cron job
# cmd syntax: ./multi_scan /path/to/base/dir comma@seperated.list,for@email.sending
# this will break down one big direectory into sub directories
# will direct output to logs

#initialize
OPTIND=1
> ~/scan.log
> ~/scan.err
> ~/scan_results.txt
DIR="$( cd "$( dirname "${BASH_SOURCE[0]}" )" && pwd )"

#do scans, append to log
find $1/* -prune -type d | while IFS= read -r d; do
    php $DIR/scan.php -md $d >> ~/scan.log 2>> ~/scan.err
    echo "Result for $d" >> ~/scan_results.txt
    tail -7 ~/scan.log >> ~/scan_results.txt
    echo "___________________________________" >> ~/scan_results.txt
    sleep 1
done

#send results and create bad list
cat ~/scan.log | grep "# ER" > ~/scan_bad_list.txt
me="$(whoami)"
IFS=',' read -r -a emails <<< "$2"
for email in "${emails[@]}"
do
    echo
    cat ~/scan_results.txt | mail -s "Gridserver scan for $me" "$email"
done
